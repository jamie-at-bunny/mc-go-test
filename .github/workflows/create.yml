name: Create App on Magic Containers

on:
  workflow_dispatch:

jobs:
  create:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Create & Deploy
        id: create
        uses: ./.github/actions/create-app
        with:
          api_key: ${{ secrets.BUNNYNET_API_KEY }}
          registry_username: ${{ github.actor }}
          registry_password: ${{ secrets.GITHUB_TOKEN }}
          ensure_bunny_registry: "true"
          bunny_registry_pat: ${{ secrets.BUNNY_GHCR_PAT }}

      - name: Summary
        run: |
          echo "### Created on Magic Containers" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App ID:** \`${{ steps.create.outputs.app_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.create.outputs.app_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Save the App ID as a repository variable called \`APP_ID\` then pushes to main will auto-deploy." >> $GITHUB_STEP_SUMMARY
